<!doctype html>
<html>
<style>
#results span {display:block;padding:0.25em 0}
body{background:black;color:white;margin:0}
#sim { position: fixed;bottom:0;right:0;text-align:center;font-weight:bold;background:black;width:4em}
</style>
<body>
<form>
  <input size=60 type=text placeholder=domain name=domain id=domain>
  <input type=text placeholder=query name=query id=query>
  <input type=submit value=search>
</form>
<div id=sim>
  <a href="#" onclick=doSearch() id=count>0</a>
</div>
<div id=results>
</div>
</body>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

<script>
var qMap = {};
function addQuery(what) {
  if(qMap[what]) { return; }
  qMap[what] = 1;
  $("#count").html(_.values(qMap).length);
}

$(function() {
  var qs = (function(a) {
      if (a == "") return {};
      var b = {};
      for (var i = 0; i < a.length; ++i)
      {
          var p=a[i].split('=', 2);
          if (p.length == 1)
              b[p[0]] = "";
          else
              b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
      }
      return b;
  })(window.location.search.substr(1).split('&'));

  $("#domain").val(qs.domain);
  $("#query").val(qs.query);

  $.getJSON("/query?" + $("#domain").val() + ";" + $("#query").val(), function(res) {
    $("#results").empty();
    _.each(res, function(row, res_ix) {
      var span = $("<span />").appendTo($("#results"));
      _.each(row[0], function(url, ix) {
        var img = $("<img />").attr({
          title: row[1][ix],
          src: url
        });
        span.append(img);

        img.click(function(){
          addQuery(row[2]);
        });

        if(ix == 0) {
          img.hover(function(){
            img.parent().children().each(function(){
              this.src = this.title;
            });
          });
        }
      });
    });
  });
});
</script>
